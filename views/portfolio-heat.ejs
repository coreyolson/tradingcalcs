<%- include('partials/header', { 
    title: 'Portfolio Heat Calculator',
    description: 'Track Total Risk Across Multiple Open Positions',
    includeChartJs: true
}) %>

        <!-- Page Header -->
        <div class="container-fluid px-4 mb-4">
            <h1 class="page-title">
                <i class="fas fa-fire"></i>
                Portfolio Heat Calculator
            </h1>
            <p class="page-subtitle">Real-Time Risk Monitoring ‚Ä¢ Multiple Positions ‚Ä¢ Portfolio Heat Management</p>
        </div>

        <div class="container-fluid px-4">
            <div class="row g-3">
                <!-- Left Column: Account & Position Management -->
                <div class="col-xl-4 col-lg-5">
                    <!-- Account Settings -->
                    <div class="card input-card mb-3">
                        <div class="card-header">
                            <i class="fas fa-wallet"></i> Account Settings
                        </div>
                        <div class="card-body compact-form">
                            <div class="input-row">
                                <label>
                                    Account Balance ($)
                                    <i class="fas fa-info-circle text-muted" style="font-size: 0.7rem; cursor: help;" 
                                       title="Your total trading capital"></i>
                                </label>
                                <input type="number" class="form-control form-control-sm" id="accountBalance" 
                                       value="100000" min="1000" step="1000" required>
                            </div>
                            <div class="input-row">
                                <label>
                                    Max Portfolio Heat (%)
                                    <i class="fas fa-info-circle text-muted" style="font-size: 0.7rem; cursor: help;" 
                                       title="Maximum acceptable total risk across all positions"></i>
                                </label>
                                <input type="number" class="form-control form-control-sm" id="maxHeat" 
                                       value="6" min="1" max="20" step="0.5" required>
                                <small class="text-muted" style="font-size: 0.7rem;">
                                    <i class="fas fa-lightbulb"></i> Recommended: 6-8%
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Add Position Form -->
                    <div class="card input-card mb-3">
                        <div class="card-header">
                            <i class="fas fa-plus-circle"></i> Add Position
                        </div>
                        <div class="card-body compact-form">
                            <form id="addPositionForm">
                                <div class="input-row">
                                    <label>Symbol</label>
                                    <input type="text" class="form-control form-control-sm" id="symbol" placeholder="AAPL" required>
                                </div>
                                <div class="input-row">
                                    <label>Entry Price</label>
                                    <input type="number" class="form-control form-control-sm" id="entryPrice" placeholder="150.00" step="0.01" required>
                                </div>
                                <div class="input-row">
                                    <label>Stop Loss</label>
                                    <input type="number" class="form-control form-control-sm" id="stopLoss" placeholder="145.00" step="0.01" required>
                                </div>
                                <div class="input-row">
                                    <label>Position Size (shares/contracts)</label>
                                    <input type="number" class="form-control form-control-sm" id="positionSize" placeholder="100" min="1" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 mt-3">
                                    <i class="fas fa-plus"></i> Add Position
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Open Positions List -->
                    <div class="card input-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-list"></i> Open Positions</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="clearAllBtn">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="positionsList" class="position-list">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p class="mb-0">No open positions</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Heat Analysis -->
                <div class="col-xl-8 col-lg-7">
                    <!-- Heat Gauge -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-temperature-high"></i> Portfolio Heat</span>
                            <div id="heatStatusBadge" style="font-size: 0.85rem;"></div>
                        </div>
                        <div class="card-body text-center">
                            <div class="heat-gauge-container mb-4">
                                <div class="heat-gauge">
                                    <div class="heat-fill" id="heatFill"></div>
                                </div>
                                <div class="heat-percentage" id="heatPercentage">0%</div>
                            </div>
                            
                            <!-- Heat Warning -->
                            <div id="heatWarning" style="display: none; margin-bottom: 1rem; padding: 1rem; background: rgba(252, 163, 17, 0.1); border-left: 4px solid #fca311; text-align: left;">
                                <div style="font-size: 0.9rem; color: #fca311;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong id="heatWarningText"></strong>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="heat-stat">
                                        <div class="stat-label">Current Heat</div>
                                        <div class="stat-value" id="currentHeat">$0</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="heat-stat">
                                        <div class="stat-label">Available Heat</div>
                                        <div class="stat-value text-success" id="availableHeat">$0</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="heat-stat">
                                        <div class="stat-label">Max Heat</div>
                                        <div class="stat-value text-info" id="maxHeatDisplay">$0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Position Details Table -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="fas fa-table"></i> Position Risk Breakdown
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-dark table-sm table-hover mb-0" id="positionsTable">
                                    <thead>
                                        <tr>
                                            <th>Symbol</th>
                                            <th class="text-end">Entry</th>
                                            <th class="text-end">Stop</th>
                                            <th class="text-end">Size</th>
                                            <th class="text-end">Risk $</th>
                                            <th class="text-end">Heat %</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="positionsTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">No positions to display</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-pie"></i> Risk Analysis
                        </div>
                        <div class="card-body">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<%- include('partials/footer') %>

<style>
    .position-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .position-item {
        padding: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        transition: background 0.2s;
    }
    
    .position-item:hover {
        background: rgba(255,255,255,0.02);
    }
    
    .position-item:last-child {
        border-bottom: none;
    }
    
    .heat-gauge-container {
        position: relative;
        padding: 2rem 0;
    }
    
    .heat-gauge {
        height: 60px;
        background: rgba(255,255,255,0.05);
        border-radius: 30px;
        overflow: hidden;
        position: relative;
        border: 2px solid rgba(0,176,255,0.3);
    }
    
    .heat-fill {
        height: 100%;
        background: linear-gradient(90deg, #00ff88 0%, #fca311 50%, #ff4444 100%);
        transition: width 0.5s ease;
        width: 0%;
    }
    
    .heat-percentage {
        font-size: 2.5rem;
        font-weight: 800;
        margin-top: 1rem;
        background: linear-gradient(135deg, #00b0ff 0%, #d68b45 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .heat-stat {
        padding: 1rem;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #9ba1a6;
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #eaeaea;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
    let positions = [];
    let riskChart = null;

    // DOM Elements
    const accountBalanceInput = document.getElementById('accountBalance');
    const maxHeatInput = document.getElementById('maxHeat');
    const addPositionForm = document.getElementById('addPositionForm');
    const positionsList = document.getElementById('positionsList');
    const positionsTableBody = document.getElementById('positionsTableBody');
    const clearAllBtn = document.getElementById('clearAllBtn');
    
    // Heat display elements
    const heatFill = document.getElementById('heatFill');
    const heatPercentage = document.getElementById('heatPercentage');
    const currentHeat = document.getElementById('currentHeat');
    const availableHeat = document.getElementById('availableHeat');
    const maxHeatDisplay = document.getElementById('maxHeatDisplay');

    // Add position handler
    addPositionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const symbol = document.getElementById('symbol').value.toUpperCase().trim();
        const entryPrice = parseFloat(document.getElementById('entryPrice').value);
        const stopLoss = parseFloat(document.getElementById('stopLoss').value);
        const positionSize = parseInt(document.getElementById('positionSize').value);
        
        // Validation
        const errors = [];
        if (!symbol) errors.push('Symbol is required');
        if (!entryPrice || entryPrice <= 0) errors.push('Entry price must be greater than $0');
        if (!stopLoss || stopLoss <= 0) errors.push('Stop loss must be greater than $0');
        if (stopLoss === entryPrice) errors.push('Stop loss cannot equal entry price');
        if (!positionSize || positionSize <= 0) errors.push('Position size must be greater than 0');
        
        if (errors.length > 0) {
            showFormError(errors);
            return;
        }
        
        clearFormError();
        
        const risk = Math.abs(entryPrice - stopLoss) * positionSize;
        
        // Sanity check: risk shouldn't exceed account balance
        const accountBalance = parseFloat(accountBalanceInput.value);
        if (risk > accountBalance) {
            showFormError(['Position risk ($' + risk.toFixed(2) + ') exceeds account balance ($' + accountBalance.toFixed(2) + ')']);
            return;
        }
        
        positions.push({
            id: Date.now(),
            symbol,
            entryPrice,
            stopLoss,
            positionSize,
            risk
        });
        
        addPositionForm.reset();
        updateDisplay();
    });

    // Clear all positions
    clearAllBtn.addEventListener('click', function() {
        if (positions.length === 0) return;
        if (confirm('Remove all positions?')) {
            positions = [];
            updateDisplay();
        }
    });

    // Remove single position
    function removePosition(id) {
        positions = positions.filter(p => p.id !== id);
        updateDisplay();
    }

    // Update all displays
    function updateDisplay() {
        const accountBalance = parseFloat(accountBalanceInput.value);
        const maxHeatPercent = parseFloat(maxHeatInput.value) / 100;
        
        // Validation
        if (!accountBalance || accountBalance <= 0) {
            showDisplayError('Account balance must be greater than $0');
            return;
        }
        if (!maxHeatPercent || maxHeatPercent <= 0 || maxHeatPercent > 1) {
            showDisplayError('Max portfolio heat must be between 1% and 100%');
            return;
        }
        
        clearDisplayError();
        
        const maxHeatDollar = accountBalance * maxHeatPercent;
        const totalRisk = positions.reduce((sum, p) => sum + p.risk, 0);
        const heatPercent = (totalRisk / accountBalance) * 100;
        const available = maxHeatDollar - totalRisk;
        
        // Validate calculations
        if (!isFinite(heatPercent) || isNaN(heatPercent)) {
            showDisplayError('Invalid calculation result');
            return;
        }
        
        // Update heat gauge
        const gaugePercent = Math.min((totalRisk / maxHeatDollar) * 100, 100);
        heatFill.style.width = gaugePercent + '%';
        heatPercentage.textContent = heatPercent.toFixed(2) + '%';
        
        // Update heat status badge and warnings
        const heatStatusBadge = document.getElementById('heatStatusBadge');
        const heatWarning = document.getElementById('heatWarning');
        const heatWarningText = document.getElementById('heatWarningText');
        
        const heatRatio = heatPercent / (maxHeatPercent * 100);
        
        if (heatPercent > maxHeatPercent * 100) {
            heatPercentage.style.color = '#ff4444';
            heatFill.style.background = '#ff4444';
            heatStatusBadge.innerHTML = '<span class="badge bg-danger">‚ö†Ô∏è Over Limit</span>';
            heatWarning.style.display = 'block';
            heatWarning.style.borderColor = '#ff4444';
            heatWarningText.style.color = '#ff4444';
            heatWarningText.innerHTML = `You're over max heat by $${(totalRisk - maxHeatDollar).toFixed(0)}. Close positions or reduce size.`;
        } else if (heatRatio > 0.9) {
            heatPercentage.style.color = '#fca311';
            heatFill.style.background = '#fca311';
            heatStatusBadge.innerHTML = '<span class="badge bg-warning">üî• Near Limit</span>';
            heatWarning.style.display = 'block';
            heatWarningText.innerHTML = `You're at ${heatPercent.toFixed(1)}% of ${(maxHeatPercent * 100).toFixed(0)}% max. Room for ~$${available.toFixed(0)} more risk.`;
        } else if (heatRatio > 0.75) {
            heatPercentage.style.color = '#00b0ff';
            heatFill.style.background = 'linear-gradient(90deg, #00ff88, #00b0ff)';
            heatStatusBadge.innerHTML = '<span class="badge bg-info">Elevated</span>';
            heatWarning.style.display = 'none';
        } else {
            heatPercentage.style.background = 'linear-gradient(135deg, #00b0ff 0%, #d68b45 100%)';
            heatPercentage.style.webkitBackgroundClip = 'text';
            heatPercentage.style.webkitTextFillColor = 'transparent';
            heatPercentage.style.backgroundClip = 'text';
            heatFill.style.background = 'linear-gradient(90deg, #00ff88, #00b0ff)';
            heatStatusBadge.innerHTML = '<span class="badge bg-success">‚úì Healthy</span>';
            heatWarning.style.display = 'none';
        }
        
        // Update stats
        currentHeat.textContent = '$' + totalRisk.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        availableHeat.textContent = '$' + Math.max(0, available).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        maxHeatDisplay.textContent = '$' + maxHeatDollar.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        // Update positions list
        if (positions.length === 0) {
            positionsList.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">No open positions</p>
                </div>
            `;
            positionsTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No positions to display</td></tr>';
        } else {
            positionsList.innerHTML = positions.map(p => `
                <div class="position-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <strong class="text-info">${p.symbol}</strong>
                        <button class="btn btn-sm btn-outline-danger" onclick="removePosition(${p.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="small text-muted">
                        Entry: $${p.entryPrice.toFixed(2)} | Stop: $${p.stopLoss.toFixed(2)}<br>
                        Size: ${p.positionSize} | Risk: $${p.risk.toFixed(2)}
                    </div>
                </div>
            `).join('');
            
            positionsTableBody.innerHTML = positions.map(p => `
                <tr>
                    <td><strong class="text-info">${p.symbol}</strong></td>
                    <td class="text-end">$${p.entryPrice.toFixed(2)}</td>
                    <td class="text-end">$${p.stopLoss.toFixed(2)}</td>
                    <td class="text-end">${p.positionSize}</td>
                    <td class="text-end">$${p.risk.toFixed(2)}</td>
                    <td class="text-end">${((p.risk/accountBalance)*100).toFixed(2)}%</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="removePosition(${p.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Update chart
        updateChart();
    }

    // Update risk chart
    function updateChart() {
        const ctx = document.getElementById('riskChart').getContext('2d');
        
        if (riskChart) {
            riskChart.destroy();
        }
        
        if (positions.length === 0) {
            return;
        }
        
        // Validate chart data
        const hasInvalidData = positions.some(p => !isFinite(p.risk) || isNaN(p.risk) || p.risk < 0);
        if (hasInvalidData) {
            console.error('Invalid data in positions, skipping chart render');
            return;
        }
        
        riskChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: positions.map(p => p.symbol),
                datasets: [{
                    data: positions.map(p => p.risk),
                    backgroundColor: [
                        '#00b0ff',
                        '#d68b45',
                        '#00ff88',
                        '#fca311',
                        '#a855f7',
                        '#00d4ff',
                        '#ff6b6b'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#eaeaea',
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Error handling functions
    function showFormError(errors) {
        const errorContainer = document.getElementById('formErrorContainer') || createFormErrorContainer();
        errorContainer.innerHTML = `
            <div class="alert alert-danger" style="margin-top: 1rem;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Invalid Input</strong>
                <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                    ${errors.map(err => `<li>${err}</li>`).join('')}
                </ul>
            </div>
        `;
        errorContainer.style.display = 'block';
    }
    
    function clearFormError() {
        const errorContainer = document.getElementById('formErrorContainer');
        if (errorContainer) {
            errorContainer.style.display = 'none';
        }
    }
    
    function showDisplayError(message) {
        const errorContainer = document.getElementById('displayErrorContainer') || createDisplayErrorContainer();
        errorContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Error:</strong> ${message}
            </div>
        `;
        errorContainer.style.display = 'block';
        
        // Reset displays
        heatFill.style.width = '0%';
        heatPercentage.textContent = '--';
        currentHeat.textContent = '--';
        availableHeat.textContent = '--';
        maxHeatDisplay.textContent = '--';
    }
    
    function clearDisplayError() {
        const errorContainer = document.getElementById('displayErrorContainer');
        if (errorContainer) {
            errorContainer.style.display = 'none';
        }
    }
    
    function createFormErrorContainer() {
        const container = document.createElement('div');
        container.id = 'formErrorContainer';
        container.style.display = 'none';
        const form = document.getElementById('addPositionForm');
        form.parentElement.appendChild(container);
        return container;
    }
    
    function createDisplayErrorContainer() {
        const container = document.createElement('div');
        container.id = 'displayErrorContainer';
        container.style.display = 'none';
        const heatCard = document.querySelector('.heat-gauge-container').parentElement;
        heatCard.insertBefore(container, heatCard.firstChild);
        return container;
    }

    // Update on account changes
    accountBalanceInput.addEventListener('input', updateDisplay);
    maxHeatInput.addEventListener('input', updateDisplay);

    // Auto-fill from profile if available
    function autoFillFromProfile() {
        if (typeof PersonalizationEngine !== 'undefined') {
            const profile = PersonalizationEngine.loadProfile();
            const autoFilledFields = [];
            
            if (profile.accountSize) {
                accountBalanceInput.value = profile.accountSize;
                autoFilledFields.push('accountBalance');
            }
            if (profile.maxPortfolioHeat) {
                maxHeatInput.value = profile.maxPortfolioHeat;
                autoFilledFields.push('maxHeat');
            } else if (profile.riskProfile) {
                // Set max heat based on risk profile
                const heatLimits = {
                    conservative: 8,
                    moderate: 12,
                    aggressive: 15
                };
                maxHeatInput.value = heatLimits[profile.riskProfile] || 8;
                autoFilledFields.push('maxHeat');
            }
            
            // Track calculator usage
            PersonalizationEngine.trackCalculatorUsage('Portfolio Heat');
        }
    }
    
    // Listen for profile updates
    window.addEventListener('profileLoaded', autoFillFromProfile);
    window.addEventListener('profileUpdated', autoFillFromProfile);
    
    // Show calculator-specific recommendations
    if (typeof PersonalizationEngine !== 'undefined') {
        PersonalizationEngine.showCalculatorRecommendations('Portfolio Heat');
    }
    
    // Initial auto-fill and display
    autoFillFromProfile();
    updateDisplay();
</script>
